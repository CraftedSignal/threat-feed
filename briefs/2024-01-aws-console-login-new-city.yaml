id: brief-2024-01-02-aws-console-login-new-city
slug: 2024-01-aws-console-login-new-city
title: AWS Console Login from New City
summary: This detection identifies AWS console logins by a user from a city they have not previously logged in from, potentially indicating account compromise or unauthorized access.
severity: medium
published_at: "2024-01-02T12:00:00Z"
content: |
    ## Overview

    This detection focuses on identifying anomalous AWS console login activity. Specifically, it flags instances where a user logs in from a city that is new or previously unobserved for that user. This behavior could indicate account compromise, a user traveling and logging in from a different location, or an insider threat scenario. The detection is based on event logs generated by AWS CloudTrail, which records API calls made within an AWS account. It leverages historical login data to establish a baseline of expected login locations for each user and triggers an alert when a deviation from this baseline is detected. This is critical for defenders as it can help quickly identify and respond to unauthorized access attempts within their AWS environment. Due to the nature of cloud environments, these detections are particularly valuable for spotting lateral movement.

    ## Attack Chain

    1.  An attacker gains access to AWS credentials, possibly through phishing, credential stuffing, or exposed access keys.
    2.  The attacker uses the compromised credentials to attempt a login to the AWS Management Console.
    3.  AWS CloudTrail logs the authentication attempt, including the username and source IP address.
    4.  The source IP address is geolocated to determine the city of origin.
    5.  The detection system compares the user's login city with their historical login locations.
    6.  If the city is new or unusual for the user, an alert is triggered.
    7.  The attacker, if successful in logging in, may attempt to enumerate AWS resources (e.g., EC2 instances, S3 buckets).
    8.  The attacker could then launch EC2 instances for cryptomining or data exfiltration, or modify security groups to allow wider access.

    ## Impact

    A successful attack stemming from unauthorized AWS console login can lead to significant data breaches, resource hijacking, and financial losses. Attackers can gain control over critical AWS services, potentially compromising sensitive data stored in S3 buckets or databases. They can also leverage compute resources for malicious purposes like cryptomining, leading to unexpected AWS costs. Depending on the attacker's privileges, they might be able to modify security policies, create new users, or even shut down critical infrastructure.
tags:
    - cloud
    - aws
    - account-compromise
references:
    - https://github.com/splunk/security_content/blob/main/detections/cloud/detect_aws_console_login_by_user_from_new_city.yml
rules:
    - title: AWS Console Login From New City
      description: Detects AWS console logins from a city not previously seen for the user.
      logsource:
        category: cloudtrail
        product: aws
      detection:
        condition: selection
        selection:
            city:
                - New York
                - Los Angeles
            eventName: ConsoleLogin
            eventSource: signin.amazonaws.com
      level: medium
      tags:
        - attack.initial_access
        - attack.t1078
      tests:
        positive:
            - name: Console login from a new city
              data:
                - city: New York
                  eventName: ConsoleLogin
                  eventSource: signin.amazonaws.com
                  user: testuser
        negative:
            - name: Console login from a known city
              data:
                - city: Seattle
                  eventName: ConsoleLogin
                  eventSource: signin.amazonaws.com
                  user: testuser
    - title: AWS Console Login Success
      description: Detects successful AWS console logins which can be combined with other rules
      logsource:
        category: cloudtrail
        product: aws
      detection:
        condition: selection
        selection:
            eventName: ConsoleLogin
            eventSource: signin.amazonaws.com
            responseElements.ConsoleLogin: Success
      level: informational
      tags:
        - attack.initial_access
        - attack.t1078
      tests:
        positive:
            - name: Successful Console Login
              data:
                - eventName: ConsoleLogin
                  eventSource: signin.amazonaws.com
                  responseElements.ConsoleLogin: Success
                  user: testuser
        negative:
            - name: Failed Console Login
              data:
                - eventName: ConsoleLogin
                  eventSource: signin.amazonaws.com
                  responseElements.ConsoleLogin: Failure
                  user: testuser
ttps:
    - tactic_id: TA0001
      tactic_name: Initial Access
      technique_id: T1078
      technique_name: Valid Accounts
