id: brief-2024-01-03-entra-id-federated-issuer-modified
slug: 2024-01-entra-id-federated-issuer-modified
title: Entra ID Service Principal Federated Issuer Modification
summary: Modification of a federated issuer associated with an Entra ID service principal can allow an attacker to hijack the service principal and gain unauthorized access to resources.
severity: high
published_at: "2024-01-03T12:00:00Z"
content: |
    ## Overview

    Entra ID (formerly Azure AD) service principals are identities used by applications and services to access resources. Federated identity allows these service principals to trust external identity providers (IdPs). If an attacker can modify the federated issuer configuration of a service principal, they can effectively hijack the identity. This involves changing the trusted issuer to one controlled by the attacker. Once the service principal trusts the attacker's IdP, they can forge tokens and authenticate as the service principal, gaining unauthorized access to resources normally protected by the service principal. The scope of impact depends on the permissions and roles assigned to the compromised service principal, but can range from read-only access to full administrative control over Azure resources.

    ## Attack Chain

    1. An attacker gains initial access to an Azure account with sufficient privileges to manage Entra ID service principals and their federated identity credentials.
    2. The attacker identifies a target service principal with valuable permissions.
    3. The attacker modifies the `federated_identity_credentials` property of the service principal, specifically the `issuer` field, to point to an identity provider controlled by the attacker.
    4. The attacker configures their malicious IdP to issue tokens with the appropriate claims to impersonate the targeted service principal.
    5. The attacker crafts a malicious token using their IdP, asserting the identity of the service principal.
    6. The attacker uses the forged token to authenticate to Azure resources that rely on the service principal for authorization.
    7. The attacker performs actions within Azure using the compromised service principal's permissions.
    8. The attacker maintains persistence by ensuring the malicious federated identity configuration remains in place.

    ## Impact

    Successful modification of a federated issuer allows attackers to impersonate legitimate service principals. Depending on the privileges assigned to the hijacked service principal, this could lead to unauthorized data access, resource modification, or even complete compromise of the Azure environment. The impact is highly dependent on the specific service principal targeted. Without proper monitoring, this type of attack can go undetected for extended periods, allowing attackers to maintain persistent access and escalate their privileges.
tags:
    - azure
    - entra_id
    - service_principal
    - federated_identity
    - persistence
references:
    - https://github.com/elastic/detection-rules/blob/main/rules/integrations/azure/persistence_entra_id_service_principal_federated_issuer_modified.toml
rules:
    - title: Detect Federated Issuer Modification on Service Principal
      description: Detects changes to the federated issuer of an Entra ID service principal.
      logsource:
        category: audit
        product: azure
      detection:
        condition: selection
        selection:
            operationName: Update servicePrincipal
            properties:
                key: federatedIdentityCredentials
                newValue|contains: issuer
      level: high
      tags:
        - attack.persistence
      tests:
        positive:
            - name: Service principal federated identity modified
              data:
                - operationName: Update servicePrincipal
                  properties:
                    key: federatedIdentityCredentials
                    newValue: '[{"id":"cred1","issuer":"https://attackers-idp.com","subject":"spn:..."}]'
        negative:
            - name: Normal service principal update
              data:
                - operationName: Update servicePrincipal
                  properties:
                    key: displayName
                    newValue: New Display Name
    - title: Detect Creation of Federated Identity Credential with Suspicious Issuer
      description: Detects the creation of federated identity credentials with issuers that are unusual or suspicious.
      logsource:
        category: audit
        product: azure
      detection:
        condition: selection
        selection:
            operationName: Create federatedIdentityCredentials
            properties:
                issuer|contains:
                    - attackers-idp.com
                    - suspicious-domain.net
      level: medium
      tags:
        - attack.persistence
      tests:
        positive:
            - name: Federated credential creation with attacker's IdP
              data:
                - operationName: Create federatedIdentityCredentials
                  properties:
                    issuer: https://attackers-idp.com
                    subject: spn:...
        negative:
            - name: Federated credential creation with legitimate IdP
              data:
                - operationName: Create federatedIdentityCredentials
                  properties:
                    issuer: https://sts.windows.net/legitimate-tenant-id/
                    subject: spn:...
